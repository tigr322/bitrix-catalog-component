<? namespace Bitrix\Main\Security\W;$GLOBALS['____878040434']= array(base64_decode(''.'dGltZ'.'Q=='),base64_decode('dG'.'ltZQ=='),base64_decode('a'.'nNvbl9kZWNvZG'.'U='),base64_decode('YX'.'JyYX'.'lf'.'b'.'WVyZ'.'2U='),base64_decode('am9pbg=='),base64_decode('a'.'m'.'9pbg=='),base64_decode('am9pbg=='),base64_decode('YX'.'JyY'.'Xlf'.'cG9w'),base64_decode('YX'.'J'.'yYXlfc2hpZnQ'.'='),base64_decode('YXJyYXlf'.'c'.'2'.'hpZn'.'Q='),base64_decode('Y'.'X'.'Jy'.'YXlf'.'c2hpZnQ='),base64_decode('YXJyYXlf'.'c2h'.'pZnQ='),base64_decode('Y'.'XJyY'.'XlfbWVy'.'Z2U='),base64_decode('aXNfYXJ'.'yYXk'.'='),base64_decode('YXJyY'.'XlfbWVyZ2U='),base64_decode('a'.'W5'.'fYXJyYXk='),base64_decode('aW5fYXJyYX'.'k='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJ'.'yYXk='),base64_decode('aW5fY'.'XJyYXk='),base64_decode('dGltZQ'.'=='),base64_decode('dGltZQ=='),base64_decode('Y'.'XJ'.'yYX'.'lfbWFw'),base64_decode('Z2V0X2xvYW'.'RlZF9'.'leHR'.'l'.'bnNpb'.'25z'),base64_decode(''.'anNvbl9lbmNvZGU='),base64_decode('a'.'nN'.'vbl9'.'lbm'.'Nv'.'ZG'.'U='),base64_decode(''.'cGhw'.'d'.'m'.'Vyc2lvbg=='),base64_decode(''.'an'.'Nvbl9lbm'.'NvZGU='),base64_decode('am9pbg='.'='));if(!function_exists(__NAMESPACE__.'\\___800266793')){function ___800266793($_121899037){static $_277212463= false; if($_277212463 == false) $_277212463=array('V1dBT'.'ExfTE9DSw==','c2V'.'jdX'.'JpdHk=',''.'REF'.'UQQ'.'==','eyI=','V1dBTExfTE'.'9'.'DSw='.'=','c2VjdX'.'JpdHk=',''.'U'.'0VDVVJJVFlf'.'V'.'1dBTEx'.'fRVhDRVBUSU9'.'O','RkFJTF9DSEVDS0lORw==','Q2F'.'uIG'.'5vdC'.'BleGVj'.'d'.'XRl'.'I'.'Hd'.'3Y'.'Wxs'.'IHJ1bGVzOiA=','IFRyYWNlOiA=','U'.'kVRV'.'UV'.'TVF9'.'VUkk=','a2V5cw==','dm'.'Fs'.'dW'.'Vz','U0VDVVJJVFlfV1dBTEx'.'fTU9ESUZZ','Lg==','U0'.'VDVVJJVFl'.'f'.'V1dBTExfVU5TRVQ'.'=','L'.'g==','U0VDVV'.'JJVF'.'l'.'f'.'V1d'.'BTE'.'xf'.'RVhJVA==',''.'Lg='.'=','Z2xvYmFs','a'.'2V5cw==','dm'.'F'.'s'.'dWVz','Z2'.'V0','Z'.'2V'.'0','c'.'G9zdA==',''.'cG9z'.'dA='.'=',''.'Y29va2ll','Y29'.'v'.'a2ll','cmV'.'xd'.'WV'.'zd'.'A='.'=','cm'.'Vxd'.'WVzd'.'A='.'=','Z'.'2xvYmFs','Z'.'2xvYm'.'Fs','bWF'.'pbl9'.'zZWM=','V1dBTExfQUNUVU'.'FMSVp'.'FX1J'.'VTEV'.'T',''.'dg==','dmVyc2l'.'vb'.'g==','aQ==','aXNJbn'.'N0YWxsZ'.'WQ=','dg'.'='.'=','aW5p','bW9kdWxlcw==','bGljZW5zZQ==','cGh'.'w','dg'.'==',''.'ZXh0','c2Vj'.'dXJpdHk=','ZG'.'I=','dHlwZQ'.'==','ZGI=','dmVyc2l'.'v'.'bg==','ZG'.'I=',''.'dHlwZQ'.'==','ZGI=','dH'.'lwZQ==',''.'dmV'.'y'.'c2lv'.'bg==','ZGI=','dmV'.'yc2lvb'.'g'.'==','ZW52a'.'XJv'.'b'.'m1l'.'bnQ=','dm1fd'.'mVyc2lvb'.'g='.'=','dm0=','d'.'g='.'=','ZW52aXJvbm1'.'lbnQ=','dm'.'1fdmVyc2lv'.'bg==','c29ja'.'2'.'V0'.'V'.'G'.'ltZW9'.'1dA==','c'.'3RyZWFtVG'.'ltZ'.'W91dA==','KCc=','ZGF0YQ==','Jyw'.'gJw==','bW9kdWxl','JywgJw==','bW9kdWxlX'.'3Zl'.'c'.'nNpb24=','Jyk=','L'.'CA=','U'.'0VDVV'.'J'.'JVFlf'.'V1dBTExf'.'R'.'VhDRV'.'BUSU9'.'O','bWF'.'pbg==','Rk'.'FJTF9SR'.'UZSRV'.'NISU'.'5H','Q'.'2FuIG'.'5vdCB'.'yZWZyZXNoI'.'Hd3YWxsIHJ1b'.'GVzOiA'.'=','IFR'.'yYWN'.'lOi'.'A'.'=','Z'.'GF'.'0YQ==','eyI=','LS0tL'.'S'.'1CR'.'UdJTiBQVUJ'.'MSUMgS0VZLS0t'.'LS'.'0=',''.'Ck1JSUJJakFOQmdr'.'cWhra'.'Uc5dzBCQV'.'FFRk'.'FBT0'.'NBUTh'.'BTUlJ'.'QkNn'.'S0NB'.'UUVBc'.'Th'.'RRTB'.'Iam1I'.'SlVTd'.'FdWNm'.'4we'.'m'.'EKUlZvTHgwMkt6Y'.'m'.'Z'.'yYlMvUDZ'.'z'.'V2F4VHp'.'3OFN'.'l'.'R1R0'.'Y'.'lRDT'.'3JwSG'.'k1U'.'UY2T1J5alovWHh'.'6'.'L0tMVTFHY'.'m9mO'.'UN'.'aM'.'wo'.'0ej'.'dTa3F'.'VdDY2aWJYd'.'k9GQng0ZncvQVBQUkdEcXR'.'tMG5EM2'.'Z'.'nR'.'3N1M1JlUG'.'d3MjlpOCt2b'.'Td'.'tdEJLSlV'.'Z'.'b'.'DRyClZwYjZ'.'zZ'.'lpFVD'.'lLRWI2VDFIRFlt'.'RXZ'.'jMWhxL2lp'.'dX'.'l4THJaWmk1U'.'TZVZ'.'m'.'Y'.'0VUV2'.'V'.'EkrN'.'jhz'.'c0ZSa1Erb'.'3dUUnkKZU9JTWJGaE0'.'vVVRt'.'ZlZZ'.'YlRSRnky'.'b1VROFdNe'.'mEybko'.'1U2'.'Fo'.'e'.'mk'.'xV'.'UtPMWpBalhUUFJye'.'mM3QWp'.'1Nj'.'M5aj'.'FP'.'MApwcHFmbTV4Z1dsRkFK'.'a0hRVGdiZGQ'.'1QVdxREZRa'.'3Q5SEtrWStUbmZ'.'CTEdWT'.'XZWeVB3'.'VEhOV'.'1'.'FZQ'.'Xc0e'.'HBnL'.'3dBC'.'lp3S'.'URBUUFCCi0tLS0tRU'.'5EIFBVQ'.'kx'.'J'.'QyBLRVktLS0tLQ='.'=');return base64_decode($_277212463[$_121899037]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_2119137561= true; public function handle(){ try{  $_1252475305= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1252475305)){ return;}  $_998616384= Cache::createInstance(); $_713701192= false; if($_998616384->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_38967726= $_998616384->getVars(); if($GLOBALS['____878040434'][0]()- $_38967726> round(0+5+5+5+5)){  $_1610983557= Application::getConnection(); $_207716360= RuleRecordTable::getTableName(); $_1610983557->truncateTable($_207716360); RuleRecordTable::cleanCache(); $_998616384->clean(___800266793(0), ___800266793(1));}} elseif($_998616384->startDataCache()){  $_998616384->endDataCache($GLOBALS['____878040434'][1]()); $_713701192= true;} foreach($_1252475305 as $_667087160){ $_334059653= new PublicKeyCipher; $_905210263= $_334059653->decrypt($_667087160[___800266793(2)], static::__1391909391()); if(!str_starts_with($_905210263, ___800266793(3))){ continue;} $_718388933= $GLOBALS['____878040434'][2]($_905210263, true); if(!empty($_718388933)){ $_1056633792= Rule::make($_718388933); $_540746952= $this->handleRule($_1056633792); $this->applyHandlingResults($_540746952);}}  if($_713701192){ $_998616384->clean(___800266793(4), ___800266793(5));}} catch(\Throwable $_1207590473){ $this->logEvent( ___800266793(6), ___800266793(7), ___800266793(8). $_1207590473->getMessage(). ___800266793(9). $_1207590473->getTraceAsString());}}  public function handleRule(Rule $_1056633792): array{ $_540746952=[]; if($_1056633792->matchPath($_SERVER[___800266793(10)])){  $_1583485344= $this->getContextElements($_1056633792->getContext()); foreach($_1583485344 as $_1318642590 => &$_1557059277){ $_540746952= $GLOBALS['____878040434'][3]($_540746952, $this->recursiveContextKeyHandle($_1318642590, $_1557059277,[], $_1056633792));}} return $_540746952;}  public function applyHandlingResults(array $_540746952){ $_1583485344= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_540746952 as $_871865674){ $_1557059277=& $_1583485344[$_871865674->getContextName()]; $_588449477= $_871865674->getRuleResult(); $_1056633792= $_871865674->getRule(); if($_588449477 instanceof ModifyResult){ if($_1056633792->getProcess() === ___800266793(11)){  static::rewriteContextKey( $_871865674->getContextName(), $_1557059277, $_871865674->getContextKey(), $_588449477->getCleanValue());} elseif($_1056633792->getProcess() === ___800266793(12)){ static::rewriteContextValue( $_871865674->getContextName(), $_1557059277, $_871865674->getContextKey(), $_588449477->getCleanValue());} $this->logEvent( ___800266793(13), $_871865674->getContextName(), $GLOBALS['____878040434'][4](___800266793(14), $_871865674->getContextKey()));} elseif($_588449477 instanceof CheckResult &&!$_588449477->isSuccess()){ if($_588449477->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_871865674->getContextName(), $_1557059277, $_871865674->getContextKey(),); $this->logEvent( ___800266793(15), $_871865674->getContextName(), $GLOBALS['____878040434'][5](___800266793(16), $_871865674->getContextKey()));} elseif($_588449477->getAction() === RuleAction::EXIT){ $this->logEvent( ___800266793(17), $_871865674->getContextName(), $GLOBALS['____878040434'][6](___800266793(18), $_871865674->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_2119137561= false;} protected function rewriteContextKey($_1318642590, &$_1557059277, $_218135748, $_1793699197){ $_521043087= $_218135748;  $GLOBALS['____878040434'][7]($_521043087); $_521043087[]= $_1793699197; if($_1318642590 === ___800266793(19)){ $_1597991839= $GLOBALS['____878040434'][8]($_218135748); $GLOBALS['____878040434'][9]($_521043087); if(empty($_218135748)){ $GLOBALS[$_1793699197]= $GLOBALS[$_1597991839]; unset($GLOBALS[$_1597991839]);} else{ $_1557059277=& $GLOBALS[$_1597991839]; $_634837771= ArrayHelper::getByNestedKey($_1557059277, $_218135748);  ArrayHelper::setByNestedKey($_1557059277, $_521043087, $_634837771);  ArrayHelper::unsetByNestedKey($_1557059277, $_218135748);}} else{ $_634837771= ArrayHelper::getByNestedKey($_1557059277, $_218135748);  ArrayHelper::setByNestedKey($_1557059277, $_521043087, $_634837771);  ArrayHelper::unsetByNestedKey($_1557059277, $_218135748);}} protected function rewriteContextValue($_1318642590, &$_1557059277, $_1948739062, $_634837771){ if($_1318642590 === 'global'){ $_1597991839= $GLOBALS['____878040434'][10]($_1948739062); if(empty($_1948739062)){ $GLOBALS[$_1597991839]= $_634837771;} else{ $_1557059277=& $GLOBALS[$_1597991839]; ArrayHelper::setByNestedKey($_1557059277, $_1948739062, $_634837771);}} else{  ArrayHelper::setByNestedKey($_1557059277, $_1948739062, $_634837771);}} protected function unsetContextValue($_1318642590, &$_1557059277, $_1948739062){ if($_1318642590 === 'global'){ $_1597991839= $GLOBALS['____878040434'][11]($_1948739062); if(empty($_1948739062)){ unset($GLOBALS[$_1597991839]);} else{ $_1557059277=& $GLOBALS[$_1597991839]; ArrayHelper::unsetByNestedKey($_1557059277, $_1948739062);}} else{ ArrayHelper::unsetByNestedKey($_1557059277, $_1948739062);}}  protected function recursiveContextKeyHandle(string $_1318642590, array &$_1557059277, array $_1486263291, Rule $_1056633792): array{  $_540746952=[]; foreach($_1557059277 as $_1251252385 => $_634837771){ $_1948739062= $GLOBALS['____878040434'][12]($_1486263291,[$_1251252385]); if($_1056633792->matchKey($_1948739062)){  if($_1056633792->getProcess() === ___800266793(20)){ $_588449477= $_1056633792->evaluate($_1251252385);} elseif($_1056633792->getProcess() === ___800266793(21)){ $_588449477= $_1056633792->evaluateValue($_634837771);}  if(!empty($_588449477) && $_588449477 instanceof RuleResult){ $_540746952[]= new HandlingResult($_1318642590, $_1948739062, $_588449477, $_1056633792);}}  if($GLOBALS['____878040434'][13]($_634837771)){ $_540746952= $GLOBALS['____878040434'][14]($_540746952, $this->recursiveContextKeyHandle( $_1318642590, $_1557059277[$_1251252385], $_1948739062, $_1056633792));}} return $_540746952;} protected function getContextElements(array $_2031845814){ $_1928560819=[]; if($GLOBALS['____878040434'][15](___800266793(22), $_2031845814, true)){ $_1928560819[___800266793(23)]= &$_GET;} if($GLOBALS['____878040434'][16](___800266793(24), $_2031845814, true)){ $_1928560819[___800266793(25)]= &$_POST;} if($GLOBALS['____878040434'][17](___800266793(26), $_2031845814, true)){ $_1928560819[___800266793(27)]= &$_COOKIE;} if($GLOBALS['____878040434'][18](___800266793(28), $_2031845814, true)){ $_1928560819[___800266793(29)]= &$_REQUEST;} if($GLOBALS['____878040434'][19](___800266793(30), $_2031845814, true)){ $_1928560819[___800266793(31)]= $GLOBALS;} return $_1928560819;} public static function refreshRules(){ try{ $_958167212= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____878040434'][20]()- $_958167212)< static::CACHE_RULES_TTL){ return;} Option::set(___800266793(32), ___800266793(33), $GLOBALS['____878040434'][21]()); $_1184659938= null;  $_2080585321= $GLOBALS['____878040434'][22](function($_1140645280){ return[___800266793(34) => $_1140645280[___800266793(35)], ___800266793(36) => (int) $_1140645280[___800266793(37)]];}, ModuleManager::getModulesFromDisk());  $_1690460067=[]; foreach($GLOBALS['____878040434'][23]() as $_16818675){ $_1878379842= new ReflectionExtension($_16818675); $_1690460067[$_16818675]=[ ___800266793(38) => $_1878379842->getVersion(), ___800266793(39) => $_1878379842->getINIEntries()];} $_1233319214=[ ___800266793(40) => $GLOBALS['____878040434'][24]($_2080585321), ___800266793(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___800266793(42) => $GLOBALS['____878040434'][25]([ ___800266793(43) => $GLOBALS['____878040434'][26](), ___800266793(44) => $_1690460067])]; if(Loader::includeModule(___800266793(45))){ $_164043189= CSecuritySystemInformation::getSystemInformation(); if(isset($_164043189[___800266793(46)][___800266793(47)]) && isset($_164043189[___800266793(48)][___800266793(49)])){ $_1233319214[___800266793(50)]=[ ___800266793(51) => $_164043189[___800266793(52)][___800266793(53)], ___800266793(54) => $_164043189[___800266793(55)][___800266793(56)]];} if(isset($_164043189[___800266793(57)][___800266793(58)])){ $_1233319214[___800266793(59)]=[___800266793(60) => $_164043189[___800266793(61)][___800266793(62)]];}}  $_2044591722= new HttpClient([ ___800266793(63) => round(0+1+1+1+1+1), ___800266793(64) => round(0+5)]); $_978249164=(new UrlProvider())->getTechDomain(); $_1251086772="https://wwall.{$_978249164}/rules.php"; $_945669960= $_2044591722->post($_1251086772, $_1233319214); if($_2044591722->getStatus() == round(0+50+50+50+50) &&!empty($_945669960)){ $_1184659938= Json::decode($_945669960);}  if($_1184659938 !== null){ $_1610983557= Application::getConnection(); $_207716360= RuleRecordTable::getTableName(); if(!empty($_1184659938)){ foreach($_1184659938 as $_2093345523){ if(!static::checkRuleSign($_2093345523)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____878040434'][27]($_2093345523));}}}  $_1610983557->truncateTable($_207716360);  if(!empty($_1184659938)){ $_1966386006=[]; foreach($_1184659938 as $_2093345523){ $_1966386006[]= ___800266793(65). $_1610983557->getSqlHelper()->forSql($_2093345523[___800266793(66)]). ___800266793(67). $_1610983557->getSqlHelper()->forSql($_2093345523[___800266793(68)]). ___800266793(69). $_1610983557->getSqlHelper()->forSql($_2093345523[___800266793(70)]). ___800266793(71);} $_220804590= $GLOBALS['____878040434'][28](___800266793(72), $_1966386006);  $_1610983557->query("INSERT INTO {$_207716360} (DATA, MODULE, MODULE_VERSION) VALUES {$_220804590}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1207590473){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___800266793(73), ___800266793(74), ___800266793(75), ___800266793(76). $_1207590473->getMessage(). ___800266793(77). $_1207590473->getTraceAsString());}} protected static function checkRuleSign($_1056633792){ $_334059653= new PublicKeyCipher; $_718388933= $_334059653->decrypt($_1056633792[___800266793(78)], static::__1391909391()); return str_starts_with($_718388933, ___800266793(79));} private static function __1391909391(){ $_1897839974= ''; $_1897839974 .= ___800266793(80); $_1897839974 .= ___800266793(81); return $_1897839974;} protected function logEvent($_1642189834, $_2130070851, $_2102188444){ if($this->_2119137561){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1642189834, 'main', $_2130070851, $_2102188444);}}}?>